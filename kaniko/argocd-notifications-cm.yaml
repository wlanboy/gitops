apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # Trigger bei erfolgreichem Sync
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.phase in ['Succeeded']
      send: [trigger-kaniko-build]

  # Template das den Kaniko Job erstellt
  template.trigger-kaniko-build: |
    webhook:
      kaniko-webhook:
        method: POST
        body: |
          {
            "app": "{{.app.metadata.name}}",
            "repo": "{{.app.spec.source.repoURL}}",
            "revision": "{{.app.status.sync.revision}}"
          }

  # Alternativ: Direkt Kubernetes Job erstellen
  service.webhook.kaniko-webhook: |
    url: http://kaniko-trigger.kaniko.svc.cluster.local:8080/build
    headers:
      - name: Content-Type
        value: application/json
